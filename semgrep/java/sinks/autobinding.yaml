rules:
  - id: autobinding
    options:
      symbolic_propagation: true
    pattern-either:
      - patterns:
        - patterns:
          - pattern: '@$MAP(...) $R $M(..., $Y $X, ...) { ... }'
          - metavariable-regex:
              metavariable: $Y
              regex: ^((?!(String|(boolean|byte|char|short|int|long|float|double|Boolean|Byte|Character|Short|Integer|Long|Float|Double|Enum|CharSequence|Number|Date|Temporal|URI|URL|Local|Class)(\[\])?)).)*$
        - pattern-not: '@$MAP(...) $R $M(..., java.io.InputStream $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., java.io.OutputStream $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., java.io.Reader $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., java.io.Writer $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., java.security.Principal $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., java.time.ZoneId $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., java.util.Locale $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., java.util.Map $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., java.util.TimeZone $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., javax.servlet.ServletRequest $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., javax.servlet.ServletResponse $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., javax.servlet.http.HttpServletRequest $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., javax.servlet.http.HttpServletResponse $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., javax.servlet.http.HttpSession $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., javax.servlet.http.PushBuilder $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., jakarta.servlet.ServletRequest $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., jakarta.servlet.ServletResponse $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., jakarta.servlet.http.HttpServletRequest $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., jakarta.servlet.http.HttpServletResponse $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., jakarta.servlet.http.HttpSession $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., jakarta.servlet.http.PushBuilder $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., org.springframework.http.HttpEntity $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., org.springframework.web.multipart.MultipartHttpServletRequest $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., org.springframework.web.multipart.MultipartRequest $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., org.springframework.web.context.request.NativeWebRequest $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., org.springframework.web.servlet.mvc.support.RedirectAttributes $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., org.springframework.web.bind.support.SessionStatus $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., org.springframework.web.util.UriComponentsBuilder $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., org.springframework.web.context.request.WebRequest $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., org.springframework.http.HttpMethod $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., org.springframework.security.core.Authentication $X, ...) { ...}'
        - pattern-not: '@$MAP(...) $R $M(..., org.springframework.ui.Model $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., org.springframework.ui.ModelMap $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., org.springframework.validation.BindingResult $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., @CookieValue(...) $Y $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., @MatrixVariable(...) $Y $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., @PathVariable(...) $Y $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., @RequestAttribute(...) $Y $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., @RequestBody(...) $Y $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., @RequestHeader(...) $Y $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., @RequestParam(...) $Y $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., @RequestPart(...) $Y $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., @SessionAttribute(...) $Y $X, ...) { ... }'
        - pattern-not: '@$MAP(...) $R $M(..., @SessionAttributes(...) $Y $X, ...) { ... }'
        - metavariable-regex:
            metavariable: $MAP
            regex: ^org.springframework.web.bind.annotation.(Request|Get|Post|Put|Delete|Patch)Mapping$
      - patterns:
        - pattern: '@$MAP(...) $R $M(..., $Y $X, ...) { ... }'
        - metavariable-pattern:
            metavariable: $MAP
            pattern: org.springframework.web.bind.annotation.ModelAttribute
    message: Method $M is using a POJO as input parameter which enable the data-binding and allow user set some hidden field of the POJO class.
    languages:
      - java
    severity: WARNING
    metadata:
      references:
        - https://xz.aliyun.com/t/128
        - http://agrrrdog.blogspot.com/2017/03/autobinding-vulns-and-spring-mvc.html
        - https://www.intruder.io/blog/spring4shell-cve-2022-22965
        - https://github.com/returntocorp/semgrep-rules/blob/develop/java/spring/security/cve/cve-2022-22965.yaml
        - https://github.com/GrrrDog/ZeroNights-HackQuest-2016